name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      should_run_e2e: ${{ steps.check.outputs.should_run_e2e }}
      e2e_scope: ${{ steps.check.outputs.e2e_scope }}
    steps:
      - name: Check E2E execution condition
        id: check
        run: |
          # Main push: Full E2E (핵심 플로우)
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "✅ Main 브랜치 Push: Full E2E 실행"
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
            echo "e2e_scope=full" >> $GITHUB_OUTPUT

          # PR with skip-e2e label: E2E 스킵 (UI 작업만)
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'skip-e2e') }}" == "true" ]]; then
            echo "⏭️  skip-e2e 라벨 감지: E2E 스킵 (Unit / Component / Integration Test만)"
            echo "should_run_e2e=false" >> $GITHUB_OUTPUT
            echo "e2e_scope=none" >> $GITHUB_OUTPUT

          # Default PR: Preview E2E 실행 (CI 본질 유지)
          else
            echo "✅ Default PR: Preview E2E 실행 (핵심 플로우)"
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
            echo "e2e_scope=preview" >> $GITHUB_OUTPUT
          fi

      - name: Display execution plan
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Event Type: ${{ github.event_name }}"
          echo "E2E 실행 여부: ${{ steps.check.outputs.should_run_e2e }}"
          echo "E2E Scope: ${{ steps.check.outputs.e2e_scope }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      # Unit + Integration + Component Tests (항상 실행)
      - name: Run Unit & Component Tests
        run: npm run test

  e2e:
    runs-on: ubuntu-latest
    needs: [code-quality, prepare]
    if: needs.prepare.outputs.should_run_e2e == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run E2E Tests (Preview)
        if: needs.prepare.outputs.e2e_scope == 'preview'
        uses: cypress-io/github-action@v6
        with:
          start: npm run dev
          wait-on: "https://localhost:5173"
          browser: chrome
          config: baseUrl=https://localhost:5173
        env:
          NODE_ENV: development
          CYPRESS_ENV: preview
          BASE_URL: https://localhost:5173
          CYPRESS_API_URL: ${{ secrets.RAILWAY_API_URL }}

      - name: Run E2E Tests (Full)
        if: needs.prepare.outputs.e2e_scope != 'preview'
        uses: cypress-io/github-action@v6
        with:
          start: npm run dev
          wait-on: "https://localhost:5173"
          browser: chrome
          config: baseUrl=https://localhost:5173
        env:
          NODE_ENV: development
          CYPRESS_ENV: debug
          BASE_URL: https://localhost:5173
          CYPRESS_API_URL: ${{ secrets.RAILWAY_API_URL }}

      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots

      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos

  summary:
    runs-on: ubuntu-latest
    needs: [prepare, code-quality, e2e]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "=== CI 실행 결과 ==="
          echo "Event: ${{ github.event_name }}"
          echo "E2E Scope: ${{ needs.prepare.outputs.e2e_scope }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "E2E: ${{ needs.e2e.result }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
