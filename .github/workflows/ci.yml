name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [main]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      should_run_e2e: ${{ steps.check.outputs.should_run_e2e }}
      e2e_scope: ${{ steps.check.outputs.e2e_scope }}
    steps:
      - name: Check E2E execution condition
        id: check
        run: |
          # Main push: Full E2E (í•µì‹¬ í”Œë¡œìš°)
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "âœ… Main ë¸Œëœì¹˜ Push: Full E2E ì‹¤í–‰"
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
            echo "e2e_scope=full" >> $GITHUB_OUTPUT

          # PR with skip-e2e label: E2E ìŠ¤í‚µ (UI ì‘ì—…ë§Œ)
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'skip-e2e') }}" == "true" ]]; then
            echo "â­ï¸ skip-e2e ë¼ë²¨ ê°ì§€: E2E ìŠ¤í‚µ (Unit / Component / Integration Testë§Œ)"
            echo "should_run_e2e=false" >> $GITHUB_OUTPUT
            echo "e2e_scope=none" >> $GITHUB_OUTPUT

          # Default PR: Preview E2E ì‹¤í–‰ (CI ë³¸ì§ˆ ìœ ì§€)
          else
            echo "âœ… Default PR: Preview E2E ì‹¤í–‰ (í•µì‹¬ í”Œë¡œìš°)"
            echo "should_run_e2e=true" >> $GITHUB_OUTPUT
            echo "e2e_scope=preview" >> $GITHUB_OUTPUT
          fi

      - name: Display execution plan
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Event Type: ${{ github.event_name }}"
          echo "E2E ì‹¤í–‰ ì—¬ë¶€: ${{ steps.check.outputs.should_run_e2e }}"
          echo "E2E Scope: ${{ steps.check.outputs.e2e_scope }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      # Unit + Integration + Component Tests (í•­ìƒ ì‹¤í–‰)
      - name: Run Unit & Component Tests
        run: npm run test

  e2e:
    runs-on: ubuntu-latest
    needs: [code-quality, prepare]
    if: needs.prepare.outputs.should_run_e2e == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E Tests (Preview)
        if: needs.prepare.outputs.e2e_scope == 'preview'
        run: npm run e2e:ci:preview
        env:
          CI: true
          NODE_ENV: production
          BASE_URL: https://localhost:5173
          PLAYWRIGHT_API_URL: ${{ secrets.RAILWAY_API_URL }}
          # ğŸ”¥ ìì²´ ì„œëª… ì¸ì¦ì„œ í—ˆìš©
          NODE_TLS_REJECT_UNAUTHORIZED: "0"

      - name: Run E2E Tests (Full)
        if: needs.prepare.outputs.e2e_scope != 'preview'
        run: npm run e2e:ci
        env:
          CI: true
          NODE_ENV: production
          BASE_URL: https://localhost:5173
          PLAYWRIGHT_API_URL: ${{ secrets.RAILWAY_API_URL }}
          # ğŸ”¥ ìì²´ ì„œëª… ì¸ì¦ì„œ í—ˆìš©
          NODE_TLS_REJECT_UNAUTHORIZED: "0"

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: failure() # ì‹¤íŒ¨ ì‹œì—ë§Œ ì—…ë¡œë“œ
        with:
          name: test-results
          path: test-results/
          retention-days: 7

  summary:
    runs-on: ubuntu-latest
    needs: [prepare, code-quality, e2e]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "=== CI ì‹¤í–‰ ê²°ê³¼ ==="
          echo "Event: ${{ github.event_name }}"
          echo "E2E Scope: ${{ needs.prepare.outputs.e2e_scope }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "E2E: ${{ needs.e2e.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
